<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Igor Dejanović">
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Entity - textX</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  <link href="../../style.css" rel="stylesheet">
  <link href="../../css/version-select.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Entity";
    var mkdocs_page_input_path = "tutorials/entity.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-68681917-1', 'igordejanovic.net');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> textX</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">User Guide</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../grammar/">Grammar</a>
                </li>
                <li class="">
                    
    <a class="" href="../../metamodel/">Meta-model</a>
                </li>
                <li class="">
                    
    <a class="" href="../../model/">Model</a>
                </li>
                <li class="">
                    
    <a class="" href="../../scoping/">Scoping</a>
                </li>
                <li class="">
                    
    <a class="" href="../../multimetamodel/">Multi meta-model</a>
                </li>
                <li class="">
                    
    <a class="" href="../../parser_config/">Parser configuration</a>
                </li>
                <li class="">
                    
    <a class="" href="../../visualization/">Visualization</a>
                </li>
                <li class="">
                    
    <a class="" href="../../error_handling/">Error handling</a>
                </li>
                <li class="">
                    
    <a class="" href="../../debugging/">Debugging</a>
                </li>
                <li class="">
                    
    <a class="" href="../../textx_command/">textx command</a>
                </li>
                <li class="">
                    
    <a class="" href="../../howto/">Howtos</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Tutorials</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../hello_world/">Hello World</a>
                </li>
                <li class="">
                    
    <a class="" href="../robot/">Robot</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Entity</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#entity-tutorial">Entity tutorial</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#entity-language">Entity language</a></li>
        
            <li><a class="toctree-l4" href="#the-grammar">The grammar</a></li>
        
            <li><a class="toctree-l4" href="#generating-source-code">Generating source code</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../state_machine/">State Machine</a>
                </li>
                <li class="">
                    
    <a class="" href="../toylanguage/">Toy language compiler</a>
                </li>
                <li class="">
                    
    <a class="" href="../self-dsl/">self-dsl</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">About</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../about/comparison/">Comparison</a>
                </li>
                <li class="">
                    
    <a class="" href="../../about/discuss/">Discuss</a>
                </li>
                <li class="">
                    
    <a class="" href="https://github.com/igordejanovic/textX/blob/master/CONTRIBUTING.md">Contributing</a>
                </li>
                <li class="">
                    
    <a class="" href="https://github.com/igordejanovic/textX/blob/master/LICENSE.txt">License</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">What's new</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../whatsnew/release_1_5/">Release 1.5</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">textX</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Tutorials &raquo;</li>
        
      
    
    <li>Entity</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/igordejanovic/textX/edit/master/docs/tutorials/entity.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="entity-tutorial">Entity tutorial<a class="headerlink" href="#entity-tutorial" title="Permanent link">&para;</a></h1>
<p>A tutorial for building ER-like language and generating Java code.</p>
<hr />
<h2 id="entity-language">Entity language<a class="headerlink" href="#entity-language" title="Permanent link">&para;</a></h2>
<p>In this example we will see how to make a simple language for data modeling.
We will use this language to generate Java source code (POJO classes).</p>
<p>Our main concept will be <code>Entity</code>. Each entity will have one or more
<code>properties</code>.  Each property is defined by its <code>name</code> and its <code>type</code>.</p>
<p>Let's sketch out a model in our language.</p>
<pre><code>entity Person {
  name : string       
  address: Address   
  age: integer      
}

entity Address {
  street : string
  city : string
  country : string
}
</code></pre>
<h2 id="the-grammar">The grammar<a class="headerlink" href="#the-grammar" title="Permanent link">&para;</a></h2>
<p>In our example we see that each entity starts with a keyword <code>entity</code>. After
that, we have a name that is the identifier and an open bracket.
Between the brackets we have properties. In textX this is written as:</p>
<pre><code>Entity:
    'entity' name=ID '{'
        properties+=Property
    '}'
;
</code></pre>
<p>We can see that the <code>Entity</code> rule references <code>Property</code> rule from the
assignment. Each property is defined by the <code>name</code>, colon (<code>:</code>) and the
type's name. This can be written as:</p>
<pre><code>Property:
    name=ID ':' type=ID
;
</code></pre>
<p>Now, grammar defined in this way will parse a single <code>Entity</code>. We haven't stated yet
that our model consists of many <code>Entity</code> instances.</p>
<p>Let's specify that. We are introducing a rule for the whole model which states
that each entity model contains one or more <code>entities</code>.</p>
<pre><code>EntityModel:
    entities+=Entity
;
</code></pre>
<p>This rule must be the first rule in the textX grammar file. First rule is always
considered a <code>root rule</code>.</p>
<p>This grammar will parse the example model from the beginning.</p>
<p>At any time you can check and visualize entity meta-model and person model
using command:</p>
<pre><code>$ textx visualize entity.tx person.ent
</code></pre>
<p>Given grammar in file <code>entity.tx</code> and example Person model in file
<code>person.ent</code>.</p>
<p>This command will produce <code>entity.tx.dot</code> and <code>person.ent.dot</code> files which can
be viewed by any dot viewer or converted to e.g. PNG format using command:</p>
<pre><code>$ dot -Tpng -O *.dot
</code></pre>
<p>Note that <a href="http://graphviz.org/">GraphViz</a> must be installed to use dot command
line utility.</p>
<p>Meta-model now looks like this:</p>
<p><img alt="Entity metamodel 1" src="entity1.tx.dot.png" /></p>
<p>While the example (Person model) looks like this:</p>
<p><img alt="Person model 1" src="person1.ent.dot.png" /></p>
<p>What you see on the model diagram are actual Python objects.
It looks good, but it would be even better if a reference to <code>Address</code> from
properties was an actual Python reference, not just a value of <code>str</code> type.</p>
<p>This resolving of object names to references can be done automatically by textX.
To do so, we shall change our <code>Property</code> rule to be:</p>
<pre><code>Property:
    name=ID ':' type=[Entity]
;
</code></pre>
<p>Now, we state that type is a reference (we are using <code>[]</code>) to an object of the <code>Entity</code>
class. This instructs textX to search for the name of the <code>Entity</code> after the 
colon and when it is found to resolve it to an <code>Entity</code> instance with the same name
defined elsewhere in the model.</p>
<p>But, we have a problem now. There are no entities called <code>string</code> and <code>integer</code>
which we used for several properties in our model. To remedy this, we must 
introduce dummy entities with those names and change <code>properties</code> attribute
assignment to be <code>zero or more</code> (<code>*=</code>) since our dummy entities will have no
attributes.</p>
<p>Although, this solution is possible it wouldn't be elegant at all. So let's
do something better. First, let's introduce an abstract concept called <code>Type</code>
which as the generalization of simple types (like <code>integer</code> and <code>string</code>) and
complex types (like <code>Entity</code>).</p>
<pre><code>Type:
  SimpleType | Entity 
;
</code></pre>
<p>This is called abstract rule, and it means that <code>Type</code> is either a <code>SimpleType</code>
or an <code>Entity</code> instance. <code>Type</code> class from the meta-model will never be
instantiated.</p>
<p>Now, we shall change our <code>Property</code> rule definition:</p>
<pre><code>Property:
    name=ID ':' type=[Type]
;
</code></pre>
<p>And, at the end, there must be a way to specify our simple types. Let's do that
at the beginning of our model.</p>
<pre><code>EntityModel:
    simple_types *= SimpleType
    entities += Entity
;
</code></pre>
<p>And the definition of <code>SimpleType</code> would be:</p>
<pre><code>SimpleType:
  'type' name=ID
;
</code></pre>
<p>So, simple types are defined at the beginning of the model using the keyword <code>type</code>
after which we specify the name of the type.</p>
<p>Our person model will now begin with:</p>
<pre><code>type string
type integer

entity Person {
...
</code></pre>
<p>Meta-model now looks like this:</p>
<p><img alt="Entity metamodel 2" src="entity.tx.dot.png" /></p>
<p>While the example (Person model) looks like this:</p>
<p><img alt="Person model 2" src="person.ent.dot.png" /></p>
<p>But, we can make this language even better. We can define some built-in simple
types so that the user does not need to specify them for every model. This has
to be done from python during meta-model instantiation. We can instantiate
<code>integer</code> and <code>string</code> simple types and introduce them in every model
programmatically.</p>
<p>The first problem is how to instantiate the <code>SimpleType</code> class. textX will dynamically
create a Python class for each rule from the grammar but we do not have access
to these classes in advance.</p>
<p>Luckily, textX offers a way to override dynamically created classes with user
supplied ones. So, we can create our class <code>SimpleType</code> and register that class
during meta-model instantiation together with two of its instances (<code>integer</code> and
<code>string</code>).</p>
<pre><code>class SimpleType(object):
  def __init__(self, parent, name):  # remember to include parent param.
    self.parent = parent
    self.name = name
</code></pre>
<p>Now, we can make a dict of builtin objects.</p>
<pre><code>myobjs =  {
  'integer': SimpleType(None, 'integer'),
  'string': SimpleType(None, 'string')
}
</code></pre>
<p>And register our custom class and two builtins on the meta-model:</p>
<pre><code>meta = metamodel_from_file('entity.tx', 
                           classes=[SimpleType],
                           builtins=myobjs)
</code></pre>
<p>Now, if we use <code>meta</code> to load our models we do not have to specify <code>integer</code> and
<code>string</code> types. Furthermore, each instance of <code>SimpleType</code> will be an instance
of our <code>SimpleType</code> class.</p>
<p>We, can use this custom classes support to implement any custom behaviour in
our object graph.</p>
<h2 id="generating-source-code">Generating source code<a class="headerlink" href="#generating-source-code" title="Permanent link">&para;</a></h2>
<p>textX doesn't impose any specific library or process for source code generation.
You can use anything you like. From the <code>print</code> function to template engines.</p>
<p>I highly recommend you to use some of the well-established <a href="https://en.wikipedia.org/wiki/Template_processor">template
engines</a>.</p>
<p>Here, we will see how to use <a href="http://jinja.pocoo.org/">Jinja2 template engine</a>
to generate Java source code from our entity models.</p>
<p>First, install jinja2 using pip:</p>
<pre><code>$ pip install Jinja2
</code></pre>
<p>Now, for each entity in our model we will render one Java file with a pair of 
getters and setters for each property.</p>
<p>Let's write Jinja2 template (file <code>java.template</code>):</p>
<pre><code>// Autogenerated from java.template file
class {{entity.name}} {

  {% for property in entity.properties %}
  protected {{property.type|javatype}} {{property.name}};
  {% endfor %}

  {% for property in entity.properties %}
  public {{property.type|javatype}} get{{property.name|capitalize}}(){
    return this.{{property.name}};
  }

  public void set{{property.name|capitalize}}({{property.type|javatype}} new_value){
    this.{{property.name}} = new_value;
  }

  {% endfor %}
}
</code></pre>
<p>Templates have static parts that will be rendered as they are, and variable parts 
whose content depends on the model. Variable parts are written inside
<code>{{}}</code>. For example <code>{{entity.name}}</code> from the second line is the name of
the current entity.</p>
<p>The logic of rendering is controlled by <code>tags</code> written in <code>{%...%}</code> (e.g. loops,
conditions).</p>
<p>We can see that this template will render a warning that this is auto-generated
code (it is always good to do that!). Then it will render a Java class named after
the current entity and then, for each property in the entity (please note that
we are using textX model so all attribute names come from the textX grammar) we
are rendering a Java attribute. After that, we are rendering getters and
setters.</p>
<p>You could notice that for rendering proper Java types we are using <code>|javatype</code>
expression. This is called <code>filter</code> in Jinja2. It works similarly to <code>unix</code> pipes.
You have an object and you pass it to some filter. Filter will transform the given
object to some other object. In this case <code>javatype</code> is a simple python function
that will transform our types (<code>integer</code> and <code>string</code>) to proper Java types
(<code>int</code> and <code>String</code>).</p>
<p>Now, let's see how we can put this together. We need to initialize the Jinja2
engine, instantiate our meta-model, load our model and then iterate over 
the entities from our model and generate a Java file for each entity:</p>
<pre><code>from os import mkdir
from os.path import exists, dirname, join
import jinja2
from textx import metamodel_from_file

this_folder = dirname(__file__)


class SimpleType(object):
    def __init__(self, parent, name):
        self.parent = parent
        self.name = name

    def __str__(self):
        return self.name


def get_entity_mm():
    """
    Builds and returns a meta-model for Entity language.
    """
    type_builtins = {
            'integer': SimpleType(None, 'integer'),
            'string': SimpleType(None, 'string')
    }
    entity_mm = metamodel_from_file(join(this_folder, 'entity.tx'),
                                    classes=[SimpleType],
                                    builtins=type_builtins)

    return entity_mm


def main(debug=False):

    # Instantiate the Entity meta-model
    entity_mm = get_entity_mm()

    def javatype(s):
        """
        Maps type names from SimpleType to Java.
        """
        return {
                'integer': 'int',
                'string': 'String'
        }.get(s.name, s.name)

    # Create the output folder
    srcgen_folder = join(this_folder, 'srcgen')
    if not exists(srcgen_folder):
        mkdir(srcgen_folder)

    # Initialize the template engine.
    jinja_env = jinja2.Environment(
        loader=jinja2.FileSystemLoader(this_folder),
        trim_blocks=True,
        lstrip_blocks=True)

    # Register the filter for mapping Entity type names to Java type names.
    jinja_env.filters['javatype'] = javatype

    # Load the Java template
    template = jinja_env.get_template('java.template')

    # Build a Person model from person.ent file
    person_model = entity_mm.model_from_file(join(this_folder, 'person.ent'))

    # Generate Java code
    for entity in person_model.entities:
        # For each entity generate java file
        with open(join(srcgen_folder,
                      "%s.java" % entity.name.capitalize()), 'w') as f:
            f.write(template.render(entity=entity))


if __name__ == "__main__":
    main()
</code></pre>
<p>And the generated code will look like this:</p>
<pre><code>// Autogenerated from java.template file
class Person {

  protected String name;
  protected Address address;
  protected int age;

  public String getName(){
    return this.name;
  }

  public void setName(String new_value){
    this.name = new_value;
  }

  public Address getAddress(){
    return this.address;
  }

  public void setAddress(Address new_value){
    this.address = new_value;
  }

  public int getAge(){
    return this.age;
  }

  public void setAge(int new_value){
    this.age = new_value;
  }

}
</code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The code from this tutorial can be found in the
<a href="https://github.com/igordejanovic/textX/tree/master/examples/Entity">examples/Entity</a>
folder.</p>
</div>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../state_machine/" class="btn btn-neutral float-right" title="State Machine">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../robot/" class="btn btn-neutral" title="Robot"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright &copy; <a href="http://igordejanovic.net/">Igor Dejanović</a>.</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/igordejanovic/textX/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../robot/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../state_machine/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../js/version-select.js" defer></script>
      <script src="../../search/main.js" defer></script>

</body>
</html>
